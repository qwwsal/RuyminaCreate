<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ryumina Create - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</title>
  <link rel="stylesheet" href="./AdministratorPageStyle.css" />
  <link rel="icon" type="image/svg+xml" href="./Image/favicon.svg">
</head>
<body>
  <header>
    <a href="./MainPage.html" class="logo-link">
      <img class="logo" src="./Image/logo.svg" alt="–õ–æ–≥–æ—Ç–∏–ø" />
    </a>

    <nav role="navigation" aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
      <a href="./MainPage.html">–ì–ª–∞–≤–Ω–∞—è</a>
      <a href="./ServicePage.html">–£—Å–ª—É–≥–∏</a>
      <a href="./PortfolioPage.html">–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ</a>
      <a href="./ReviewsPage.html">–û—Ç–∑—ã–≤—ã</a>
    </nav>

    <a href="#" id="profileLink" aria-label="–ö–Ω–æ–ø–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è">
      <img class="user" src="./Image/User.svg" alt="–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
    </a>
  </header>

  <main>
    <!-- –ò–Ω—Ñ–æ –æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–µ -->
    <section class="section-block" aria-label="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞">
      <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—Å</h2>
      <p><b>–ò–º—è:</b> <span id="adminFirstName"></span></p>
      <p><b>–§–∞–º–∏–ª–∏—è:</b> <span id="adminLastName"></span></p>
      <p><b>–ü–æ—á—Ç–∞:</b> <span id="adminEmail"></span></p>
      <button id="logoutBtn" aria-label="–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞" style="display: block; margin: 20px auto;">–í—ã–π—Ç–∏</button>
    </section>

    <!-- –ó–∞–∫–∞–∑—ã -->
    <section class="section-block" aria-label="–°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤">
      <h2>–í—Å–µ –∑–∞–∫–∞–∑—ã</h2>
      <div>
        <button id="showPendingBtn">–ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
        <button id="showCompletedBtn">–ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
        <button id="showAllBtn">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>
      </div>
      <div id="ordersList" class="orders-list" role="list"></div>
    </section>

    <!-- –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ -->
    <section class="section-block" aria-label="–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ">
      <h2>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ</h2>
      <form id="portfolioForm" enctype="multipart/form-data">
        <input type="text" name="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required />
        <textarea name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" rows="2" required></textarea>
        <input type="file" name="images" multiple accept="image/*" />
        <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
      </form>
      <div id="portfolioFeedback"></div>
    </section>

    <!-- –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —É—Å–ª—É–≥—É -->
    <section class="section-block" aria-label="–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É">
      <h2>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —É—Å–ª—É–≥—É</h2>
      <form id="serviceForm">
        <input type="text" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏" required />
        <input type="text" name="short_description" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ" />
        <textarea name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" rows="3"></textarea>
        <input type="number" name="price" placeholder="–¶–µ–Ω–∞ (—Ä—É–±.)" step="0.01" required />
        <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
      </form>
      <div id="serviceFeedback"></div>
    </section>

    <!-- –ü–æ—Å–ª–µ —Å–µ–∫—Ü–∏–∏ "–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —É—Å–ª—É–≥—É" -->
<section class="section-block" aria-label="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏">
  <h2>üõ†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ</h2>
  
  <div class="duplicate-controls">
    <button id="checkDuplicatesBtn" class="btn-check">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã</button>
    <button id="cleanupDuplicatesBtn" class="btn-cleanup" style="display: none;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã</button>
  </div>
  
  <div id="duplicatesResults" class="duplicates-results" style="display: none;">
    <h3>–ù–∞–π–¥–µ–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã:</h3>
    <div id="duplicatesList"></div>
  </div>
  
  <div id="cleanupResults" class="cleanup-results" style="display: none;"></div>
</section>
  </main>

  <footer>
    <div class="footer-logo">
      <a href="./MainPage.html" class="logo-link">
        <img class="logo" src="./Image/logo.svg" alt="–õ–æ–≥–æ—Ç–∏–ø" />
      </a>
    </div>
    <div>–Ø –≤ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç—è—Ö</div>
    <div class="social-icons" role="list" aria-label="–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏">
      <a href="https://www.instagram.com/iitspo?igsh=MjAxNG8wMGd3cXo2" target="_blank" rel="noopener noreferrer">
        <img class="socials" src="./Image/Instagram.svg" alt="Instagram" />
      </a>
      <a href="https://www.behance.net/polinaryumina" target="_blank" rel="noopener noreferrer">
        <img class="socials" src="./Image/Behance.svg" alt="Behance" />
      </a>
      <a href="https://vk.com/iprmn" target="_blank" rel="noopener noreferrer">
        <img class="socials" src="./Image/VK.svg" alt="VK" />
      </a>
    </div>
  </footer>

  <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–≤–µ—Ä—Ö" -->
  <button id="scrollToTop" aria-label="–ù–∞–≤–µ—Ä—Ö" title="–ù–∞–≤–µ—Ä—Ö">
    ‚Üë
  </button>

  <script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–≤–µ—Ä—Ö"
    function initScrollToTop() {
      const scrollToTopBtn = document.getElementById('scrollToTop');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ
      window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
          scrollToTopBtn.style.display = 'flex';
        } else {
          scrollToTopBtn.style.display = 'none';
        }
      });
      
      // –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –Ω–∞–≤–µ—Ä—Ö –ø—Ä–∏ –∫–ª–∏–∫–µ
      scrollToTopBtn.addEventListener('click', function() {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });
    }

    // –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï API URL –î–õ–Ø –ü–†–û–î–ê–ö–®–ï–ù–ê
    const API_URL = window.location.origin;
    console.log('API URL:', API_URL);

    const adminFirstName = document.getElementById('adminFirstName');
    const adminLastName = document.getElementById('adminLastName');
    const adminEmail = document.getElementById('adminEmail');
    const logoutBtn = document.getElementById('logoutBtn');
    const ordersList = document.getElementById('ordersList');
    const showPendingBtn = document.getElementById('showPendingBtn');
    const showCompletedBtn = document.getElementById('showCompletedBtn');
    const showAllBtn = document.getElementById('showAllBtn');
    const portfolioForm = document.getElementById('portfolioForm');
    const portfolioFeedback = document.getElementById('portfolioFeedback');
    const serviceForm = document.getElementById('serviceForm');
    const serviceFeedback = document.getElementById('serviceFeedback');

    let allOrders = [];
    let currentFilter = null;

    function getAdminData() {
      const userData = localStorage.getItem('user');
      if (!userData) {
        window.location.href = './RegisterPage.html';
        return null;
      }
      return JSON.parse(userData);
    }

    async function loadAdminInfoAndOrders() {
      const admin = getAdminData();
      if (!admin) return;

      adminFirstName.textContent = admin.firstName || '';
      adminLastName.textContent = admin.lastName || '';
      adminEmail.textContent = admin.email || '';

      try {
        console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞...');
        const response = await fetch(`${API_URL}/orders?isAdmin=1&userId=${admin.id}`);
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤');
        allOrders = await response.json();
        console.log('–ó–∞–≥—Ä—É–∂–µ–Ω—ã –∑–∞–∫–∞–∑—ã:', allOrders);
        renderOrders(allOrders, currentFilter);
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:', err);
        ordersList.innerHTML = `<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤: ${err.message}</p>`;
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ URL —Ñ–∞–π–ª–∞
    function getFileUrl(filePath) {
      console.log('–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞:', filePath);
      
      // –ï—Å–ª–∏ —ç—Ç–æ —É–∂–µ Cloud URL - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –µ—Å—Ç—å
      if (filePath.startsWith('http')) {
        return filePath;
      }
      
      // –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç–∞—Ä—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—É—Ç—å (/uploads/filename) - –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ Cloud URL
      if (filePath.startsWith('/uploads/')) {
        const fileName = filePath.replace('/uploads/', '');
        const cloudUrl = `https://storage.yandexcloud.net/ruyminacreate/orders/${fileName}`;
        console.log('–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—É—Ç—å –≤ Cloud URL:', cloudUrl);
        return cloudUrl;
      }
      
      // –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –∏–º—è —Ñ–∞–π–ª–∞ –±–µ–∑ –ø—É—Ç–∏ - –¥–æ–±–∞–≤–ª—è–µ–º –∫ API URL (–Ω–∞ —Å–ª—É—á–∞–π —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π)
      return `${API_URL}/uploads/${filePath}`;
    }

    function renderOrders(orders, filterStatus = null) {
      ordersList.innerHTML = '';
      let filtered = orders;
      if (filterStatus !== null) {
        filtered = orders.filter(order => order.status === filterStatus);
      }
      
      if (filtered.length === 0) {
        ordersList.textContent = filterStatus ? 
          `–ó–∞–∫–∞–∑—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "${filterStatus}" –Ω–µ –Ω–∞–π–¥–µ–Ω—ã` : 
          '–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
        return;
      }
      
      filtered.forEach(order => {
        const div = document.createElement('div');
        div.classList.add('order-item');
        const statusClass = order.status === 'completed' ? 'status-completed' : 'status-pending';

        let filesHtml = '–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç';
        try {
          const files = order.file_urls ? JSON.parse(order.file_urls) : [];
          if (files.length) {
            filesHtml = files.map(filePath => {
              const url = getFileUrl(filePath);
              const fileName = url.split('/').pop();
              return `<a href="${url}" target="_blank" rel="noopener noreferrer" title="–û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª: ${fileName}">${fileName}</a>`;
            }).join(', ');
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–æ–≤ –∑–∞–∫–∞–∑–∞:', error);
          filesHtml = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤';
        }

        div.innerHTML = `
          <strong>–ó–∞–∫–∞–∑ ‚Ññ${order.id} - ${order.service_name || '–£—Å–ª—É–≥–∞'}</strong>
          <p><b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> ${order.user_email || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
          <p><b>–û–ø–∏—Å–∞–Ω–∏–µ:</b> ${order.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
          <p><b>–§–∞–π–ª—ã:</b> ${filesHtml}</p>
          <p class="${statusClass}"><b>–°—Ç–∞—Ç—É—Å:</b> ${order.status || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}</p>
          ${order.status === 'pending' ? 
            `<button class="complete-btn" data-id="${order.id}">–í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–∫–∞–∑</button>` : 
            '<p><em>–ó–∞–∫–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω</em></p>'
          }
        `;
        ordersList.appendChild(div);
      });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–∫–∞–∑–æ–≤
    showPendingBtn.addEventListener('click', () => {
      currentFilter = 'pending';
      renderOrders(allOrders, currentFilter);
    });
    
    showCompletedBtn.addEventListener('click', () => {
      currentFilter = 'completed';
      renderOrders(allOrders, currentFilter);
    });
    
    showAllBtn.addEventListener('click', () => {
      currentFilter = null;
      renderOrders(allOrders, currentFilter);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É "–í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–∫–∞–∑"
    ordersList.addEventListener('click', async (event) => {
      if (event.target.classList.contains('complete-btn')) {
        const orderId = event.target.dataset.id;
        const button = event.target;
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
        button.disabled = true;
        button.textContent = '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';
        
        try {
          console.log(`–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ ${orderId} –Ω–∞ completed`);
          
          const response = await fetch(`${API_URL}/orders/${orderId}/status`, {
            method: 'PATCH',
            headers: { 
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: 'completed' })
          });

          console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status);

          if (!response.ok) {
            let errorText;
            try {
              const errorData = await response.json();
              errorText = errorData.error || `–û—à–∏–±–∫–∞ ${response.status}`;
            } catch {
              errorText = await response.text();
            }
            throw new Error(errorText);
          }

          const result = await response.json();
          console.log('–°—Ç–∞—Ç—É—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω:', result);
          
          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã
          await loadAdminInfoAndOrders();
          
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞:', err);
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞: ' + err.message);
          
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
          button.disabled = false;
          button.textContent = '–í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–∫–∞–∑';
        }
      }
    });

    portfolioForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      portfolioFeedback.textContent = '';
      const admin = getAdminData();
      if (!admin) return;

      const formData = new FormData(portfolioForm);
      formData.append('userId', admin.id);

      try {
        const response = await fetch(`${API_URL}/portfolio`, {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText);
        }

        const result = await response.json();
        portfolioFeedback.textContent = '–ó–∞–ø–∏—Å—å –≤ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞! ID: ' + result.id;
        portfolioFeedback.style.color = 'green';
        portfolioForm.reset();
      } catch (err) {
        portfolioFeedback.textContent = '–û—à–∏–±–∫–∞: ' + err.message;
        portfolioFeedback.style.color = 'red';
      }
    });

    serviceForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      serviceFeedback.textContent = '';
      const admin = getAdminData();
      if (!admin) return;
      
      const formData = new FormData(serviceForm);
      const name = formData.get('name').trim();
      const short_description = formData.get('short_description').trim();
      const description = formData.get('description').trim();
      const price = parseFloat(formData.get('price'));
      
      if (!name || isNaN(price)) {
        serviceFeedback.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω—É.';
        serviceFeedback.style.color = 'red';
        return;
      }
      
      try {
        const response = await fetch(`${API_URL}/services`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: admin.id,
            name,
            short_description,
            description,
            price
          }),
        });
        
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥–∏');
        
        serviceFeedback.textContent = '–£—Å–ª—É–≥–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞! ID: ' + result.id;
        serviceFeedback.style.color = 'green';
        serviceForm.reset();
      } catch (err) {
        serviceFeedback.textContent = '–û—à–∏–±–∫–∞: ' + err.message;
        serviceFeedback.style.color = 'red';
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–≤–µ—Ä—Ö"
      initScrollToTop();
      
      const userStr = localStorage.getItem('user');
      if (!userStr) {
        window.location.href = './RegisterPage.html';
        return;
      }
      const user = JSON.parse(userStr);
      if (!(user.email && user.email.toLowerCase() === 'polina@mail.ru')) {
        window.location.href = `./ProfilePage.html?userId=${user.id || ''}`;
        return;
      }
      loadAdminInfoAndOrders();
    });

    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('user');
      window.location.href = './AutorizationPage.html';
    });


        // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏
    const checkDuplicatesBtn = document.getElementById('checkDuplicatesBtn');
    const cleanupDuplicatesBtn = document.getElementById('cleanupDuplicatesBtn');
    const duplicatesResults = document.getElementById('duplicatesResults');
    const duplicatesList = document.getElementById('duplicatesList');
    const cleanupResults = document.getElementById('cleanupResults');

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
    checkDuplicatesBtn.addEventListener('click', async () => {
      try {
        checkDuplicatesBtn.disabled = true;
        checkDuplicatesBtn.textContent = 'üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º...';
        
        const response = await fetch(`${API_URL}/api/portfolio/duplicates`);
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤');
        }
        
        displayDuplicates(data.duplicates);
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:', error);
        showCleanupResult('–û—à–∏–±–∫–∞: ' + error.message, true);
      } finally {
        checkDuplicatesBtn.disabled = false;
        checkDuplicatesBtn.textContent = 'üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã';
      }
    });

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
    function displayDuplicates(duplicates) {
      if (duplicates.length === 0) {
        duplicatesList.innerHTML = '<p>‚úÖ –î—É–±–ª–∏–∫–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        cleanupDuplicatesBtn.style.display = 'none';
      } else {
        duplicatesList.innerHTML = duplicates.map(group => `
          <div class="duplicate-group">
            <h4>${group.title}</h4>
            <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</strong> ${group.count} –∑–∞–ø–∏—Å–µ–π</p>
            <p><strong>ID –∑–∞–ø–∏—Å–µ–π:</strong> <span class="duplicate-ids">${group.ids}</span></p>
            ${group.description ? `<p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${group.description}</p>` : ''}
          </div>
        `).join('');
        
        cleanupDuplicatesBtn.style.display = 'inline-block';
      }
      
      duplicatesResults.style.display = 'block';
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
    cleanupDuplicatesBtn.addEventListener('click', async () => {
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ?\n\n–ë—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —Ç–æ–ª—å–∫–æ —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ (—Å –Ω–∞–∏–º–µ–Ω—å—à–∏–º–∏ ID).')) {
        return;
      }
      
      try {
        cleanupDuplicatesBtn.disabled = true;
        cleanupDuplicatesBtn.textContent = 'üóëÔ∏è –£–¥–∞–ª—è–µ–º...';
        
        const response = await fetch(`${API_URL}/api/portfolio/cleanup-duplicates`, {
          method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤');
        }
        
        showCleanupResult(`‚úÖ ${data.message}\n\n–£–¥–∞–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${data.totalDeleted}`);
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        cleanupDuplicatesBtn.style.display = 'none';
        duplicatesResults.style.display = 'none';
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:', error);
        showCleanupResult('–û—à–∏–±–∫–∞: ' + error.message, true);
      } finally {
        cleanupDuplicatesBtn.disabled = false;
        cleanupDuplicatesBtn.textContent = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã';
      }
    });

    // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—á–∏—Å—Ç–∫–∏
    function showCleanupResult(message, isError = false) {
      cleanupResults.innerHTML = message;
      cleanupResults.style.display = 'block';
      cleanupResults.className = isError ? 'cleanup-results error' : 'cleanup-results';
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
      setTimeout(() => {
        cleanupResults.style.display = 'none';
      }, 10000);
    }
  </script>
</body>
</html>